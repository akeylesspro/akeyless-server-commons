{
  "metadata": {
    "source_file": "src/helpers/email_helpers.ts",
    "path": "docs/helpers/email_helpers.md",
    "type": "module"
  },
  "purpose": "Email sending functionality using SendGrid API, with comprehensive attachment support from files, buffers, or URLs. Includes automatic audit logging and group-based recipient management.",
  "dependencies": [
    "@sendgrid/mail - SendGrid email API client",
    "fs and path - File system operations for reading files",
    "Firebase helpers:",
    "  - add_audit_record - Logs email operations to audit trail",
    "  - get_document_by_id - Fetches email settings from Firestore",
    "  - ignore_ssl_request - HTTP request helper for downloading attachments",
    "Types: EmailData, EmailSettings, EmailAttachment from src/types/interfaces/email",
    "logger manager - Error and debug logging"
  ],
  "sections": [
    {
      "title": "Attachment Creation Utilities",
      "exports": [
        {
          "name": "create_attachment_from_file",
          "signature": "create_attachment_from_file(file_path: string, filename?: string, disposition: \"attachment\" | \"inline\" = \"attachment\"): Promise<EmailAttachment>",
          "type": "function",
          "description": "Creates an email attachment from a local file path.",
          "parameters": [
            {
              "name": "file_path",
              "type": "string",
              "description": "Full path to the file to attach"
            },
            {
              "name": "filename",
              "type": "string",
              "optional": true,
              "description": "Optional custom filename (defaults to basename of file_path)"
            },
            {
              "name": "disposition",
              "type": "\"attachment\" | \"inline\"",
              "default": "\"attachment\"",
              "description": "\"attachment\" (download) or \"inline\" (display in email body), defaults to \"attachment\""
            }
          ],
          "returns": "Promise resolving to EmailAttachment object with base64 content",
          "behavior": [
            "Reads file synchronously using fs.readFileSync",
            "Converts content to base64",
            "Detects MIME type from file extension",
            "Returns attachment object ready for SendGrid"
          ],
          "throws": "Re-throws file read errors with context",
          "examples": [
            {
              "code": "const attachment = await create_attachment_from_file(\n  '/path/to/invoice.pdf',\n  'invoice_2024.pdf',\n  'attachment'\n);",
              "language": "typescript"
            }
          ]
        },
        {
          "name": "create_attachment_from_buffer",
          "signature": "create_attachment_from_buffer(buffer: Buffer | Uint8Array, filename: string, mime_type: string, disposition: \"attachment\" | \"inline\" = \"attachment\"): EmailAttachment",
          "type": "function",
          "description": "Creates an email attachment from an in-memory buffer.",
          "parameters": [
            {
              "name": "buffer",
              "type": "Buffer | Uint8Array",
              "description": "Buffer or Uint8Array containing file data"
            },
            {
              "name": "filename",
              "type": "string",
              "description": "Filename for the attachment"
            },
            {
              "name": "mime_type",
              "type": "string",
              "description": "MIME type string (e.g., \"application/pdf\", \"image/png\")"
            },
            {
              "name": "disposition",
              "type": "\"attachment\" | \"inline\"",
              "default": "\"attachment\"",
              "description": "\"attachment\" or \"inline\", defaults to \"attachment\""
            }
          ],
          "returns": "EmailAttachment object with base64 content",
          "behavior": [
            "Converts buffer to base64 string",
            "No file I/O required, suitable for dynamically generated content"
          ],
          "examples": [
            {
              "code": "const pdfBuffer = generatePDFBuffer();\nconst attachment = create_attachment_from_buffer(\n  pdfBuffer,\n  'report.pdf',\n  'application/pdf'\n);",
              "language": "typescript"
            }
          ]
        },
        {
          "name": "create_attachment_from_url",
          "signature": "create_attachment_from_url(url: string, filename: string): Promise<EmailAttachment>",
          "type": "function",
          "description": "Downloads a file from a URL and creates an email attachment.",
          "parameters": [
            {
              "name": "url",
              "type": "string",
              "description": "HTTP/HTTPS URL to download from"
            },
            {
              "name": "filename",
              "type": "string",
              "description": "Filename for the attachment"
            }
          ],
          "returns": "Promise resolving to EmailAttachment object",
          "behavior": [
            "Uses ignore_ssl_request helper (supports SSL verification bypass in QA mode)",
            "Downloads binary data with 20-second timeout",
            "Detects content type from response headers (defaults to \"application/pdf\")",
            "Converts to base64 and returns attachment object"
          ],
          "throws": "Re-throws download errors with context",
          "examples": [
            {
              "code": "const attachment = await create_attachment_from_url(\n  'https://example.com/document.pdf',\n  'downloaded_doc.pdf'\n);",
              "language": "typescript"
            }
          ]
        },
        {
          "name": "get_mime_type",
          "signature": "get_mime_type(file_path: string): string",
          "type": "function",
          "internal": true,
          "description": "Maps file extensions to MIME types.",
          "supported_extensions": [
            "Documents: .pdf, .doc, .docx, .xls, .xlsx, .ppt, .pptx, .txt, .csv, .json, .xml",
            "Archives: .zip, .rar, .7z",
            "Images: .jpg, .jpeg, .png, .gif, .bmp, .svg",
            "Media: .mp3, .mp4, .avi, .mov"
          ],
          "returns": "MIME type string or \"application/octet-stream\" for unknown extensions"
        }
      ]
    },
    {
      "title": "Email Sending",
      "exports": [
        {
          "name": "send_email",
          "signature": "send_email(email_data: EmailData, options?: { debug?: boolean }): Promise<void>",
          "type": "function",
          "description": "Sends an email via SendGrid with support for groups, attachments, and audit logging.",
          "parameters": [
            {
              "name": "email_data",
              "type": "EmailData",
              "description": "EmailData object containing:",
              "properties": [
                {
                  "name": "to",
                  "type": "string | string[]",
                  "optional": true,
                  "description": "String or array of recipient email addresses (optional if group_name provided)"
                },
                {
                  "name": "cc",
                  "type": "string | string[]",
                  "optional": true,
                  "description": "String or array of CC addresses (optional)"
                },
                {
                  "name": "group_name",
                  "type": "string",
                  "optional": true,
                  "description": "Name of email group from settings (optional if to provided)"
                },
                {
                  "name": "from",
                  "type": "string | { email: string; name?: string }",
                  "optional": true,
                  "description": "Sender email (optional, uses default_from from settings)"
                },
                {
                  "name": "subject",
                  "type": "string",
                  "description": "Email subject line"
                },
                {
                  "name": "body_html",
                  "type": "string",
                  "optional": true,
                  "description": "HTML email body (optional if body_plain_text provided)"
                },
                {
                  "name": "body_plain_text",
                  "type": "string",
                  "optional": true,
                  "description": "Plain text email body (optional if body_html provided)"
                },
                {
                  "name": "attachments",
                  "type": "EmailAttachment[]",
                  "optional": true,
                  "description": "Array of EmailAttachment objects (optional)"
                },
                {
                  "name": "entity_for_audit",
                  "type": "string",
                  "description": "Entity identifier for audit logging"
                }
              ]
            },
            {
              "name": "options",
              "type": "{ debug?: boolean }",
              "optional": true,
              "description": "Optional configuration:",
              "properties": [
                {
                  "name": "debug",
                  "type": "boolean",
                  "default": "false",
                  "description": "Enable debug logging (default: false)"
                }
              ]
            }
          ],
          "returns": "Promise<void>",
          "behavior": [
            "1. Fetches email settings from Firestore (nx-settings/emails document)",
            "2. Validates that either to or group_name is provided",
            "3. Validates that either body_html or body_plain_text is provided",
            "4. If group_name provided:",
            "   - Validates group exists in settings",
            "   - Merges group recipients with explicit to addresses",
            "   - Merges group CC addresses",
            "5. Merges default CC addresses from settings",
            "6. Sets SendGrid API key from settings",
            "7. Builds SendGrid message payload (HTML or text based on available body)",
            "8. Sends email via SendGrid API",
            "9. Validates response status code (expects 202)",
            "10. Writes audit record to nx-audit collection",
            "11. Optionally logs success/failure details"
          ],
          "throws": [
            "\"must supply a 'group_name' or 'to' value\" - Missing recipients",
            "\"must supply a 'body_plain_text' or 'html' value\" - Missing body content",
            "\"must supply a valid 'group_name'\" - Invalid group name",
            "SendGrid API errors (status code != 202)"
          ],
          "error_handling": [
            "Logs errors but does not throw (allows graceful failure)",
            "Optionally logs email payload on error if debug enabled"
          ],
          "examples": [
            {
              "code": "await send_email({\n  to: 'user@example.com',\n  subject: 'Welcome',\n  body_html: '<h1>Welcome to our service!</h1>',\n  entity_for_audit: 'user_registration'\n}, { debug: true });\n\n// Using group\nawait send_email({\n  group_name: 'admins',\n  subject: 'System Alert',\n  body_html: '<p>System status update</p>',\n  entity_for_audit: 'system_notification',\n  attachments: [attachment]\n});",
              "language": "typescript"
            }
          ]
        }
      ]
    },
    {
      "title": "Email Settings Structure",
      "description": "Email settings are stored in Firestore at nx-settings/emails with the following structure:",
      "code_block": {
        "code": "interface EmailSettings {\n  sendgrid_api_key: string;\n  default_from: string;\n  default_cc: string[];\n  groups: {\n    [groupName: string]: {\n      to: string[];\n      cc?: string[];\n    };\n  };\n}",
        "language": "typescript"
      }
    }
  ],
  "context": [
    "Provides a consistent email flow with:",
    "- **Centralized Configuration** - Settings stored in Firestore, easy to update without code changes",
    "- **Group Management** - Predefined recipient groups for common use cases",
    "- **Attachment Support** - Multiple ways to attach files (local, buffer, URL)",
    "- **Audit Trail** - All emails logged to nx-audit collection for compliance",
    "- **Error Resilience** - Graceful error handling with optional debug logging",
    "Common use cases:",
    "- User registration emails",
    "- Password reset emails",
    "- System notifications",
    "- Report generation and distribution",
    "- Invoice and document delivery"
  ]
}
