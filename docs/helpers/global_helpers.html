<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/helpers/global_helpers.ts</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/helpers/global_helpers.ts</h1>
    
    <h2>Purpose</h2>
    <p>General-purpose server utilities for environment validation, JSON response formatting, service URL resolution, geocoding, type guards, data normalization, and HTTP request helpers. These are foundational utilities used across the entire application.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><code>fs.readFileSync</code> - File system operations for reading package.json</li>
      <li><code>axios</code> - HTTP client for API requests</li>
      <li><code>https</code> - HTTPS module for SSL configuration</li>
      <li><a href="../managers/cache_manager.html"><code>cache_manager</code></a> - Accesses cached settings for geocoding API keys</li>
      <li><a href="../managers/logger_manager.html"><code>logger</code></a> - Logging utility</li>
      <li>Types:
        <ul>
          <li><code>JsonOK</code>, <code>JsonFailed</code> from <a href="../types/index.html"><code>src/types</code></a></li>
          <li><code>NxServiceNameMap</code> from <a href="../types/index.html"><code>src/types</code></a></li>
          <li><code>Geo</code>, <code>LanguageOptions</code>, <code>TObject</code> from <code>akeyless-types-commons</code></li>
        </ul>
      </li>
    </ul>

    <h2>Environment Validation</h2>
    
    <h3><code>init_env_variables(required_vars: string[] = []): TObject&lt;string&gt;</code></h3>
    <p>Validates required environment variables and returns all environment variables as a typed object.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>required_vars</code> - Array of required environment variable names</li>
    </ul>
    <p><strong>Returns:</strong> Object mapping all environment variable names to their string values</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Validates each required variable exists in <code>process.env</code></li>
      <li>Logs error and exits process (exit code 1) if any required variable is missing</li>
      <li>Returns object containing all environment variables (not just required ones)</li>
    </ul>
    <p><strong>Throws:</strong> Process exits with code 1 if required variable missing</p>
    <p><strong>Example:</strong></p>
    <pre><code>// Validates and loads all env vars
const env = init_env_variables(['mode', 'port', 'project_id']);

// Access variables
const mode = env.mode;
const port = env.port;</code></pre>

    <h2>JSON Response Helpers</h2>
    
    <h3><code>json_ok(data: TObject&lt;any&gt; | TObject&lt;any&gt;[]): JsonOK</code></h3>
    <p>Creates a standardized success JSON response.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>data</code> - Data to return (object or array)</li>
    </ul>
    <p><strong>Returns:</strong> Object with <code>{ success: true, data }</code> structure</p>
    <p><strong>Example:</strong></p>
    <pre><code>res.json(json_ok({ user: 'John', id: '123' }));
// Returns: { success: true, data: { user: 'John', id: '123' } }

res.json(json_ok([{ id: '1' }, { id: '2' }]));
// Returns: { success: true, data: [{ id: '1' }, { id: '2' }] }</code></pre>

    <h3><code>json_failed(error: any, msg?: string): JsonFailed</code></h3>
    <p>Creates a standardized error JSON response.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>error</code> - Error object, Error instance, or error message string</li>
      <li><code>msg</code> - Optional additional error message</li>
    </ul>
    <p><strong>Returns:</strong> Object with <code>{ success: false, error, msg }</code> structure</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Extracts error message from Error instances</li>
      <li>Falls back to error string or default message if error is not an Error</li>
      <li>Default error message: <code>"general error: something happened "</code></li>
    </ul>
    <p><strong>Example:</strong></p>
    <pre><code>res.json(json_failed(new Error('User not found'), 'Failed to fetch user'));
// Returns: { success: false, error: 'User not found', msg: 'Failed to fetch user' }</code></pre>

    <h3><code>parse_error(error: any): { name?: string, message?: string } | any</code></h3>
    <p>Normalizes error objects to a consistent format.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>error</code> - Error instance or any value</li>
    </ul>
    <p><strong>Returns:</strong></p>
    <ul>
      <li>If Error instance: <code>{ name: error.name, message: error.message }</code></li>
      <li>Otherwise: returns error as-is</li>
    </ul>

    <h2>Utility Functions</h2>
    
    <h3><code>get_version(packageJsonPath: string): string</code></h3>
    <p>Reads and extracts version from package.json file.</p>
    <p><strong>Returns:</strong> Version string from package.json</p>
    <p><strong>Throws:</strong> JSON parse errors if package.json is invalid</p>

    <h3><code>sleep(ms: number = 2500): Promise&lt;void&gt;</code></h3>
    <p>Creates a promise-based delay (sleep function).</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>ms</code> - Milliseconds to wait (default: <code>2500</code>)</li>
    </ul>
    <p><strong>Returns:</strong> Promise that resolves after specified delay</p>

    <h2>Service URL Resolution</h2>
    
    <h3><code>get_nx_service_urls(env_name: string = "mode"): NxServiceNameMap</code></h3>
    <p>Resolves base URLs for all NX microservices based on environment.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>env_name</code> - Environment variable name to check (default: <code>"mode"</code>)</li>
    </ul>
    <p><strong>Returns:</strong> Object mapping service names to base URLs</p>
    <p><strong>Service URLs by Environment:</strong></p>
    <p><strong>Local:</strong> <code>bi</code>, <code>call_center</code>, <code>dashboard</code>, <code>devices</code>, <code>end_users</code>, <code>notifications</code>, <code>installer</code>, <code>ox_server</code>, <code>toolbox</code></p>
    <p><strong>Production:</strong> All services use <code>https://nx-api.info</code> or specific domains</p>
    <p><strong>QA:</strong> All services use <code>https://nx-api.xyz</code> or specific domains</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Reads environment variable (default: <code>process.env.mode</code>)</li>
      <li>Maps values: <code>"production"</code> or <code>"prod"</code> → <code>prod</code> URLs, <code>"qa"</code> → <code>qa</code> URLs, Otherwise → <code>local</code> URLs</li>
      <li>Throws error if environment variable is missing</li>
    </ul>

    <h2>Geocoding</h2>
    
    <h3><code>get_address_by_geo({ lat, lng }: Geo, currentLanguage: LanguageOptions): Promise&lt;string&gt;</code></h3>
    <p>Reverse geocodes coordinates to a formatted address using Google Geocoding API.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>lat</code> - Latitude (-90 to 90)</li>
      <li><code>lng</code> - Longitude (-180 to 180)</li>
      <li><code>currentLanguage</code> - Language preference (<code>LanguageOptions.He</code> or <code>LanguageOptions.En</code>)</li>
    </ul>
    <p><strong>Returns:</strong> Promise resolving to formatted address string (truncated to 35 characters) or empty string</p>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li>Validates coordinates are within valid ranges</li>
      <li>Maps language: <code>LanguageOptions.He</code> → <code>"iw"</code> (Hebrew), Otherwise → <code>"en"</code> (English)</li>
      <li>Retrieves Google Geocoding API key from cached <code>nx-settings.google.geocode_api_key</code></li>
      <li>Calls Google Geocoding API with coordinates and language</li>
      <li>Extracts <code>formatted_address</code> from first result</li>
      <li>Truncates to 35 characters</li>
      <li>Returns empty string on error or if no results</li>
    </ol>
    <p><strong>Throws:</strong> <code>Error("missing env google api key")</code> if API key not found in settings</p>

    <h2>Type Guards and Utilities</h2>
    
    <h3><code>validate_and_cast&lt;T&gt;(variable: any, condition: Boolean): variable is T</code></h3>
    <p>TypeScript type guard helper for runtime type validation.</p>

    <h3><code>get_or_default&lt;T&gt;(value: T | undefined, default_value: T | (() =&gt; T)): T</code></h3>
    <p>Returns value if defined, otherwise returns default (supports lazy evaluation).</p>

    <h2>Data Normalization</h2>
    
    <h3><code>trim_strings&lt;T&gt;(input: any): any</code></h3>
    <p>Recursively trims all string values in objects and arrays.</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Strings: Returns trimmed string</li>
      <li>Arrays: Recursively trims each element</li>
      <li>Objects: Recursively trims all properties</li>
      <li>Preserves special types: <code>Date</code>, <code>RegExp</code>, <code>Map</code>, <code>Set</code> (returns as-is)</li>
      <li>Primitives: Returns as-is</li>
    </ul>

    <h3><code>remove_nulls_and_undefined(obj: Record&lt;string, any&gt;): Record&lt;string, any&gt;</code></h3>
    <p>Removes properties with <code>null</code> or <code>undefined</code> values from an object.</p>

    <h2>HTTP Helpers</h2>
    
    <h3><code>ignore_ssl_request(config: AxiosRequestConfig): Promise&lt;AxiosResponse&gt;</code></h3>
    <p>Makes an HTTP request with optional SSL verification bypass for QA environment.</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Checks <code>mode</code> environment variable</li>
      <li>If <code>mode === "qa"</code>, disables SSL certificate verification</li>
      <li>Otherwise, uses default SSL verification</li>
      <li>Makes request using <code>axios</code></li>
    </ul>
    <p><strong>Security Note:</strong> SSL verification is disabled only in QA environment for testing purposes</p>

    <h2>Context</h2>
    <p>These utilities provide foundational functionality used throughout the application:</p>
    <ul>
      <li><strong>Environment Management</strong> - Centralized env var validation and access</li>
      <li><strong>API Responses</strong> - Consistent JSON response format across all endpoints</li>
      <li><strong>Service Communication</strong> - Environment-aware service URL resolution</li>
      <li><strong>Data Normalization</strong> - String trimming and null removal for clean data</li>
      <li><strong>Geocoding</strong> - Address lookup from coordinates</li>
      <li><strong>Type Safety</strong> - TypeScript type guards and utilities</li>
    </ul>
    <p><strong>Best Practices:</strong></p>
    <ul>
      <li>Always use <code>init_env_variables()</code> at application startup</li>
      <li>Use <code>json_ok()</code> and <code>json_failed()</code> for all API responses</li>
      <li>Use <code>trim_strings()</code> on user input before processing</li>
      <li>Use <code>get_nx_service_urls()</code> for inter-service communication</li>
      <li>Use <code>ignore_ssl_request()</code> only when necessary (QA environment)</li>
    </ul>
    </div>
  </body>
</html>
