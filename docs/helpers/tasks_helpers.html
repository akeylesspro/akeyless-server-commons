<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/helpers/tasks_helpers.ts</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/helpers/tasks_helpers.ts</h1>
    
    <h2>Purpose</h2>
    <p>Task execution orchestration with status tracking, result caching, and optional persistence to Firestore or Firebase Storage. Designed for scheduled/recurring backend tasks that need to track execution status, cache results, and optionally persist large datasets.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><a href="../managers/cache_manager.html"><code>cache_manager</code></a> - In-memory cache for task results</li>
      <li><a href="../managers/logger_manager.html"><code>logger</code></a> - Logging utility</li>
      <li>Firebase helpers: <a href="firebase_helpers.html"><code>set_document</code></a>, <a href="firebase_helpers.html"><code>get_document_by_id_optional</code></a></li>
      <li>Firebase Admin <code>storage</code> - File storage for large datasets</li>
      <li>Types from <code>akeyless-types-commons</code>: <code>TObject</code></li>
      <li><code>performance</code> - Performance timing API</li>
    </ul>

    <h2>Enums and Types</h2>
    <ul>
      <li><code>TaskName</code> enum - Predefined task names: <code>send_reset_sms</code>, <code>collect_devices_health</code>, <code>collect_charge_locations</code>, <code>collect_charge_cdrs</code></li>
      <li><code>TaskStatus</code> enum - Task execution status: <code>running</code>, <code>completed</code>, <code>failed</code>, <code>suspeneded</code></li>
      <li><code>TaskSaveOptions</code> type - Where to save results: <code>"storage"</code> | <code>"db"</code> | <code>"none"</code></li>
    </ul>

    <h2>Task Execution</h2>
    
    <h3><code>execute_task&lt;T&gt;(source: string, task_name: TaskName, task: () =&gt; Promise&lt;T&gt;, options?: ExecuteTaskOptions): Promise&lt;void&gt;</code></h3>
    <p>Executes a task function with status tracking and result persistence.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>source</code> - Source identifier (e.g., service name, scheduler name)</li>
      <li><code>task_name</code> - Task name from <code>TaskName</code> enum</li>
      <li><code>task</code> - Async function that performs the actual work</li>
      <li><code>options</code> - Optional configuration:
        <ul>
          <li><code>save_in</code> - Where to save results: <code>"storage"</code> | <code>"db"</code> | <code>"none"</code></li>
          <li><code>debug_logs</code> - Enable debug logging (default: <code>true</code>)</li>
        </ul>
      </li>
    </ul>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li>Writes "running" status to <code>nx-tasks</code> collection</li>
      <li>Executes task function and records execution duration</li>
      <li>On success: Updates status to "completed", saves data based on <code>save_in</code> option (cache, Firestore, or Storage)</li>
      <li>On error: Updates status to "failed", logs error</li>
    </ol>

    <h2>Task Data Retrieval</h2>
    
    <h3><code>get_task_data&lt;T&gt;(task_name: TaskName): Promise&lt;T&gt;</code></h3>
    <p>Retrieves task result data with caching and fallback logic.</p>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li>Checks cache first (array or object)</li>
      <li>Falls back to Firestore document</li>
      <li>If data is Storage URL, downloads from Firebase Storage</li>
      <li>Caches fetched data for future access</li>
      <li>Returns empty array if no data found</li>
    </ol>

    <h2>Storage Helpers</h2>
    <ul>
      <li><code>get_task_data_from_storage(task_name)</code> - Downloads and parses task data from Firebase Storage</li>
      <li><code>keep_task_data_in_storage(task_name, data)</code> - Uploads task data to Firebase Storage and returns signed URL (7-day expiration)</li>
    </ul>

    <h2>Context</h2>
    <p>This module provides a complete task execution framework:</p>
    <ul>
      <li><strong>Status Tracking</strong> - Monitor task execution in real-time</li>
      <li><strong>Result Caching</strong> - Fast access to task results via cache</li>
      <li><strong>Flexible Persistence</strong> - Choose storage location based on data size</li>
      <li><strong>Error Handling</strong> - Comprehensive error tracking and logging</li>
      <li><strong>Performance Monitoring</strong> - Execution time tracking</li>
    </ul>
    <p><strong>Best Practices:</strong></p>
    <ul>
      <li>Use <code>"storage"</code> for large datasets (&gt;1MB)</li>
      <li>Use <code>"db"</code> for small datasets (&lt;100KB)</li>
      <li>Use <code>"none"</code> for tasks that don't produce data</li>
      <li>Check task status before executing (avoid concurrent runs)</li>
    </ul>
    </div>
  </body>
</html>
