{
  "metadata": {
    "source_file": "src/helpers/notification_helpers.ts",
    "path": "docs/helpers/notification_helpers.md",
    "type": "module"
  },
  "purpose": "SMS and push notification helpers for sending messages to users via multiple SMS providers (Multisend, Twilio, Monogoto) and Firebase Cloud Messaging (FCM). Includes intelligent provider selection, SMS group expansion, event-based push notifications, and comprehensive audit logging.",
  "dependencies": [
    "axios - HTTP client for SMS provider APIs",
    "FormData - Form data encoding for Multisend API",
    "Twilio - Twilio SDK for international SMS",
    "Firebase messaging - FCM push notification service",
    "cache_manager - Accesses cached collections and settings",
    "logger - Logging utility",
    "translation_manager - Translation lookup for push notifications",
    "add_document from firebase_helpers - Persists SMS records",
    "add_audit_record from firebase_helpers - Audit logging",
    "get_nx_settings from firebase_helpers - Retrieves SMS provider settings",
    "is_iccid from phone_number_helpers - ICCID number detection",
    "is_international_phone_number from phone_number_helpers - International format detection",
    "is_israel_long_phone_number from phone_number_helpers - Israeli format detection",
    "is_thailand_long_phone_number from phone_number_helpers - Thai format detection",
    "EventFromDevice from akeyless-types-commons - Device event structure",
    "TObject from akeyless-types-commons - Generic object type",
    "uuid - Unique ID generation for SMS tracking",
    "Timestamp - Firestore timestamp"
  ],
  "sections": [
    {
      "title": "SMS Provider Selection",
      "description": "The system automatically selects SMS provider based on recipient number:",
      "points": [
        "ICCID Numbers (19-22 digits starting with 89) → Monogoto - Used for device-to-device SMS via SIM cards, Requires authentication with Monogoto API",
        "International Numbers (not Israeli, not Thai) → Twilio - Used for international SMS delivery, Requires Twilio account credentials",
        "Israeli/Thai Numbers → Multisend - Default provider for local Israeli numbers, Supports both local and international formats"
      ]
    },
    {
      "title": "SMS Functions",
      "exports": [
        {
          "name": "send_sms",
          "signature": "send_sms(recepient: string, text: string, entity_for_audit: string, details?: TObject<any>): Promise<void>",
          "type": "function",
          "description": "Sends SMS to recipient(s) with automatic provider selection and group expansion.",
          "parameters": [
            {
              "name": "recepient",
              "type": "string",
              "description": "Phone number or SMS group name from settings"
            },
            {
              "name": "text",
              "type": "string",
              "description": "SMS message text"
            },
            {
              "name": "entity_for_audit",
              "type": "string",
              "description": "Entity identifier for audit logging"
            },
            {
              "name": "details",
              "type": "TObject<any>",
              "optional": true,
              "description": "Optional additional details for logging"
            }
          ],
          "returns": "Promise resolving when all SMS messages are sent",
          "behavior": [
            "Group Expansion: Checks if recepient matches an SMS group in nx-settings.sms_groups.values, If group found, expands to all numbers in group, Otherwise, uses recipient as single number",
            "Deduplication: Removes duplicate phone numbers from recipient list",
            "Parallel Sending: Sends SMS to all recipients in parallel using Promise.all, Each send includes provider selection logic",
            "Provider Selection (per recipient): If ICCID → uses send_iccid_sms (Monogoto), If international (not Israeli, not Thai) → uses send_international_sms (Twilio), Otherwise → uses send_local_sms (Multisend)",
            "Audit Logging: Writes audit record for each successful send, Includes recipient, message, and provider used"
          ],
          "throws": "Error message if any SMS send fails",
          "error_handling": [
            "Errors are logged with entity context",
            "Throws error message: \"{entity_for_audit}, send_sms failed: {error}\""
          ],
          "examples": [
            {
              "code": "// Single recipient\nawait send_sms('+972501234567', 'Your code is 1234', 'user_verification');\n\n// SMS group\nawait send_sms('admins', 'System alert', 'system_notification', { alert_type: 'critical' });",
              "language": "typescript"
            }
          ]
        },
        {
          "name": "send_local_sms",
          "signature": "send_local_sms(recepient: string, text: string, details?: TObject<any>): Promise<\"multisend\">",
          "type": "function",
          "description": "Sends SMS via Multisend API for Israeli/local numbers.",
          "internal": true,
          "parameters": [
            {
              "name": "recepient",
              "type": "string",
              "description": "Phone number"
            },
            {
              "name": "text",
              "type": "string",
              "description": "SMS message"
            },
            {
              "name": "details",
              "type": "TObject<any>",
              "optional": true,
              "description": "Optional details"
            }
          ],
          "returns": "Promise resolving to \"multisend\" provider name",
          "behavior": [
            "Retrieves Multisend credentials from nx-settings.sms_provider.multisend",
            "Creates FormData with: user, password, from, recipient, message",
            "Generates unique message ID using UUID",
            "Sets international: \"1\" flag if recipient is international format",
            "Sends POST request to Multisend API",
            "Validates response (status 200 and success: true)",
            "Persists SMS record via keep_outgoing_sms",
            "Logs success"
          ],
          "throws": "Error if API request fails or response indicates failure"
        },
        {
          "name": "send_international_sms",
          "signature": "send_international_sms(recepient: string, text: string, details?: TObject<any>): Promise<\"twilio\">",
          "type": "function",
          "description": "Sends SMS via Twilio API for international numbers.",
          "internal": true,
          "parameters": [
            {
              "name": "recepient",
              "type": "string",
              "description": "Phone number"
            },
            {
              "name": "text",
              "type": "string",
              "description": "SMS message"
            },
            {
              "name": "details",
              "type": "TObject<any>",
              "optional": true,
              "description": "Optional details"
            }
          ],
          "returns": "Promise resolving to \"twilio\" provider name",
          "behavior": [
            "Retrieves Twilio credentials from nx-settings.sms_provider.twilio",
            "Creates Twilio client with account SID and token",
            "Sends message using messaging service SID",
            "Validates response (checks for errorMessage)",
            "Persists SMS record via keep_outgoing_sms",
            "Logs success"
          ],
          "throws": "Error if Twilio API call fails"
        },
        {
          "name": "send_iccid_sms",
          "signature": "send_iccid_sms(recepient: string, text: string, details?: TObject<any>): Promise<\"monogoto\">",
          "type": "function",
          "description": "Sends SMS via Monogoto API for ICCID numbers (device SIM cards).",
          "internal": true,
          "parameters": [
            {
              "name": "recepient",
              "type": "string",
              "description": "Phone number"
            },
            {
              "name": "text",
              "type": "string",
              "description": "SMS message"
            },
            {
              "name": "details",
              "type": "TObject<any>",
              "optional": true,
              "description": "Optional details"
            }
          ],
          "returns": "Promise resolving to \"monogoto\" provider name",
          "behavior": [
            "Authenticates with Monogoto API (login_to_monogoto)",
            "Retrieves Monogoto credentials from settings",
            "Sends SMS to device using ICCID: ThingId_ICCID_{recepient}",
            "Includes authorization token and customer API key",
            "Validates response (status 200)",
            "Persists SMS record via keep_outgoing_sms",
            "Logs success"
          ],
          "throws": "Error if authentication or SMS send fails"
        },
        {
          "name": "login_to_monogoto",
          "signature": "login_to_monogoto(): Promise<any>",
          "type": "function",
          "description": "Authenticates with Monogoto API and returns token.",
          "internal": true,
          "returns": "Promise resolving to authentication response with token and CustomerId",
          "throws": "Error if authentication fails"
        },
        {
          "name": "keep_outgoing_sms",
          "signature": "keep_outgoing_sms(recepient: string, content: string, service: string, external_id: string, details?: TObject<any>): Promise<void>",
          "type": "function",
          "description": "Persists outbound SMS record to Firestore.",
          "internal": true,
          "parameters": [
            {
              "name": "recepient",
              "type": "string",
              "description": "Recipient phone number"
            },
            {
              "name": "content",
              "type": "string",
              "description": "SMS message content"
            },
            {
              "name": "service",
              "type": "string",
              "description": "Provider name (\"multisend\", \"twilio\", or \"monogoto\")"
            },
            {
              "name": "external_id",
              "type": "string",
              "description": "External provider message ID"
            },
            {
              "name": "details",
              "type": "TObject<any>",
              "optional": true,
              "description": "Optional additional details"
            }
          ],
          "behavior": [
            "Creates document in nx-sms-out collection",
            "Includes: external_id, content, recipient, service, timestamp, status: \"new\", details",
            "Uses Firestore Timestamp.now() for timestamp"
          ]
        }
      ]
    },
    {
      "title": "Push Notifications",
      "exports": [
        {
          "name": "push_event_to_mobile_users",
          "signature": "push_event_to_mobile_users(event: EventFromDevice): Promise<void>",
          "type": "function",
          "description": "Sends push notifications to mobile app users for device events.",
          "parameters": [
            {
              "name": "event",
              "type": "EventFromDevice",
              "description": "Event object with: car_number, event_id, event_name, source"
            }
          ],
          "returns": "Promise resolving when all notifications are sent",
          "behavior": [
            "Cache Validation: Reads cached collections: units, usersUnits, mobile_users_app_pro, app_pro_extra_pushes, Throws error if any cache is empty",
            "Main Driver Resolution: Finds unit by car_number, Finds mobile user by matching unit.userPhone with mobile_users_app_pro.short_phone_number",
            "Secondary Drivers Resolution: Finds all usersUnits entries for the vehicle, Matches usersUnits.phone with mobile_users_app_pro.long_phone_number",
            "Extra Drivers Resolution: Finds app_pro_extra_pushes entries for the vehicle, Matches uid values with mobile_users_app_pro.uid",
            "Event Filtering: Checks mobile_user.disabled_events[car_number][source] array, Skips notification if event ID is in disabled list, Normalizes source: \"erm\" or \"erm2\" → \"erm\"",
            "Translation: Gets user language (heb, en, or ru), Maps to translation language code (he, en, ru), Looks up title from push_notifications translations, Looks up body from events_from_device translations using event_name",
            "Notification Sending: Calls send_fcm_message for each user, Uses user's FCM token"
          ],
          "throws": "Error if cached data is missing",
          "examples": [
            {
              "code": "await push_event_to_mobile_users({\n  car_number: '12345',\n  event_id: 'speed_limit',\n  event_name: 'speed_limit_exceeded',\n  source: 'erm'\n});",
              "language": "typescript"
            }
          ]
        },
        {
          "name": "send_fcm_message",
          "signature": "send_fcm_message(title: string, body: string, fcm_tokens: string[], custom_sound?: string): Promise<{success: boolean, response: string, success_count?: number, failure_count?: number}>",
          "type": "function",
          "description": "Sends Firebase Cloud Messaging (FCM) push notifications to multiple devices.",
          "parameters": [
            {
              "name": "title",
              "type": "string",
              "description": "Notification title"
            },
            {
              "name": "body",
              "type": "string",
              "description": "Notification body text"
            },
            {
              "name": "fcm_tokens",
              "type": "string[]",
              "description": "Array of FCM registration tokens"
            },
            {
              "name": "custom_sound",
              "type": "string",
              "optional": true,
              "description": "Optional custom sound file name (without extension)"
            }
          ],
          "returns": "Promise resolving to result object: success, response, success_count, failure_count",
          "behavior": [
            "Deduplication: Removes duplicate FCM tokens using Set",
            "Validation: Returns early with error if no tokens provided",
            "Message Construction: Creates MulticastMessage with tokens, notification, android config (ttl: 3600000, priority: \"high\", custom sound and channel ID), apns config (custom sound with .wav extension, alert with title and body)",
            "Sending: Uses Firebase messaging.sendEachForMulticast, Handles partial success (some tokens succeed, some fail)",
            "Logging: Logs success/failure summary, Includes response details for debugging"
          ],
          "error_handling": [
            "Catches exceptions and returns error result",
            "Never throws errors (returns error object instead)"
          ],
          "examples": [
            {
              "code": "const result = await send_fcm_message(\n  'New Message',\n  'You have a notification',\n  ['token1', 'token2'],\n  'notification_sound'\n);\n\nif (result.success) {\n  console.log(`Sent to ${result.success_count} devices`);\n}",
              "language": "typescript"
            }
          ]
        }
      ]
    },
    {
      "title": "SMS Settings Structure",
      "description": "SMS provider settings are stored in nx-settings.sms_provider:",
      "code_block": {
        "code": "{\n  multisend: {\n    user: string;\n    password: string;\n    from: string;\n  };\n  twilio: {\n    account_sid: string;\n    token: string;\n    messaging_service_sid: string;\n  };\n  monogoto: {\n    user: string;\n    password: string;\n    from: string;\n  };\n  sms_groups: {\n    values: {\n      [groupName: string]: string[]; // Array of phone numbers\n    };\n  };\n}",
        "language": "typescript"
      }
    }
  ],
  "context": [
    "This module provides comprehensive notification capabilities:",
    "- **Multi-Provider SMS** - Automatic provider selection based on recipient",
    "- **SMS Groups** - Send to multiple recipients via group names",
    "- **Event-Based Push** - Automatic push notifications for device events",
    "- **User Filtering** - Respects user preferences for disabled events",
    "- **Multi-Language** - Supports Hebrew, English, and Russian",
    "- **Audit Trail** - All SMS sends logged for compliance",
    "- **Parallel Processing** - Efficient batch sending",
    "**Common Use Cases:**",
    "- User verification codes",
    "- Password reset links",
    "- System alerts and notifications",
    "- Device event notifications (speed, geofence, etc.)",
    "- Marketing messages (via SMS groups)"
  ],
  "best_practices": [
    "Use SMS groups for common recipient lists",
    "Always provide entity_for_audit for tracking",
    "Handle FCM token failures gracefully (tokens can expire)",
    "Use translations for push notifications (don't hardcode text)",
    "Check user disabled events before sending push notifications"
  ]
}
