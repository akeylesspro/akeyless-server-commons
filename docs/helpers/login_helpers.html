<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/helpers/login_helpers.ts</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/helpers/login_helpers.ts</h1>
    
    <h2>Purpose</h2>
    <p>User lookup helpers for finding NX users and mobile app users by various identifiers (email, phone number, UID). Supports flexible identifier resolution with automatic format detection and normalization.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><a href="firebase_helpers.html"><code>query_document_optional</code></a> from <code>firebase_helpers</code> - Non-throwing Firestore query helper</li>
      <li><a href="../managers/logger_manager.html"><code>logger</code></a> manager - Imported but not currently used</li>
      <li>Types from <code>akeyless-types-commons</code>:
        <ul>
          <li><code>NxUser</code> - NX user data structure</li>
          <li><code>MobileAppUser</code> - Mobile app user data structure</li>
        </ul>
      </li>
    </ul>

    <h2>Exports and behavior</h2>
    
    <h3><code>convert_to_short_phone_number(phone_number: string): string</code></h3>
    <p>Converts an Israeli international phone number format to local format.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>phone_number</code> - Phone number in format <code>+972XXXXXXXXX</code></li>
    </ul>
    <p><strong>Returns:</strong> Phone number in format <code>0XXXXXXXXX</code></p>
    <p><strong>Example:</strong> <code>+972501234567</code> â†’ <code>0501234567</code></p>

    <h3><code>get_user_by_identifier(identifier: string, ignore_log: boolean = false): Promise&lt;NxUser | null&gt;</code></h3>
    <p>Finds an NX user by email or phone number with automatic format detection.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>identifier</code> - Email address or phone number</li>
      <li><code>ignore_log</code> - Whether to suppress error logging (default: <code>false</code>)</li>
    </ul>
    <p><strong>Returns:</strong> Promise resolving to <code>NxUser</code> object or <code>null</code> if not found</p>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li><strong>Email Detection:</strong> If identifier contains <code>"@"</code> and <code>"."</code>, queries <code>nx-users</code> collection by <code>email</code> field</li>
      <li><strong>Phone Number Detection:</strong> Otherwise treats as phone number, converts to short format, queries by <code>phone_number</code> field using Firestore <code>in</code> operator to match both short and long formats</li>
    </ol>
    <p><strong>Error Handling:</strong> Never throws errors (uses <code>query_document_optional</code>), returns <code>null</code> if user not found</p>

    <h3><code>get_mobile_app_user_by_uid(uid: string, ignore_log: boolean = false): Promise&lt;MobileAppUser | null&gt;</code></h3>
    <p>Finds a mobile app user by Firebase UID.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>uid</code> - Firebase user UID</li>
      <li><code>ignore_log</code> - Whether to suppress error logging (default: <code>false</code>)</li>
    </ul>
    <p><strong>Returns:</strong> Promise resolving to <code>MobileAppUser</code> object or <code>null</code> if not found</p>
    <p><strong>Behavior:</strong> Queries <code>mobile_users_app_pro</code> collection by <code>uid</code> field</p>

    <h2>Context</h2>
    <p>These helpers are used for:</p>
    <ul>
      <li><strong>Authentication</strong> - Finding users during login/registration flows</li>
      <li><strong>User Lookup</strong> - Resolving user identities from various identifiers</li>
      <li><strong>Phone/Email Resolution</strong> - Converting between different identifier formats</li>
      <li><strong>Mobile App Integration</strong> - Finding mobile app users by Firebase UID</li>
    </ul>
    <p><strong>Best Practices:</strong></p>
    <ul>
      <li>Use <code>get_user_by_identifier</code> for flexible identifier resolution</li>
      <li>Use <code>get_mobile_app_user_by_uid</code> specifically for Firebase Auth UIDs</li>
      <li>Handle <code>null</code> returns appropriately (user not found)</li>
      <li>Use <code>ignore_log: true</code> for non-critical lookups to reduce log noise</li>
    </ul>
    </div>
  </body>
</html>
