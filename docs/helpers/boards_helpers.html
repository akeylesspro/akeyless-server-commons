<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/helpers/boards_helpers.ts</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/helpers/boards_helpers.ts</h1>
    
    <h2>Purpose</h2>
    <p>Board-provider utilities for resolving board makers (providers) based on board types and cached settings. These helpers enable services to determine which board provider (ERM, Jimi, Ruptela, Servision, or Jimi IoT Hub) should handle a specific board type or vehicle.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><a href="../managers/cache_manager.html"><code>cache_manager</code></a> - Accesses cached <code>settings</code> and <code>boards</code> collections</li>
      <li>Types from <code>akeyless-types-commons</code>:
        <ul>
          <li><code>Board</code> - Board data structure with <code>imei</code> and <code>type</code> properties</li>
          <li><code>Car</code> - Vehicle data structure with <code>carId</code> and <code>peripherals</code> array</li>
          <li><code>TObject</code> - Generic object type</li>
        </ul>
      </li>
    </ul>

    <h2>Exports and behavior</h2>
    
    <h3><code>extract_board_types_from_settings(settings: TObject&lt;any&gt;): BoardProviderWithBoardTypes[]</code></h3>
    <p>Extracts board type configurations from settings object and organizes them by provider.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>settings</code> - Settings object containing board type arrays for each provider</li>
    </ul>
    <p><strong>Returns:</strong> Array of objects with <code>board_provider</code> and <code>board_types</code> properties</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Extracts board types from: <code>erm_board_types</code>, <code>jimi_board_types</code>, <code>jimi_iothub_board_types</code>, <code>ruptela_board_types</code>, <code>servision_board_types</code></li>
      <li>Each entry contains <code>values</code> array with board type strings</li>
      <li>Returns structured array mapping each provider to its board types</li>
    </ul>
    <p><strong>Example:</strong></p>
    <pre><code>const settings = {
  erm_board_types: { values: ['type1', 'type2'] },
  jimi_board_types: { values: ['type3'] },
  // ...
};
const providers = extract_board_types_from_settings(settings);
// Returns: [
//   { board_provider: 'erm', board_types: ['type1', 'type2'] },
//   { board_provider: 'jimi', board_types: ['type3'] },
//   ...
// ]</code></pre>

    <h3><code>get_board_maker_by_board_type(type: string): BoardMakerResult</code></h3>
    <p>Determines the board provider (maker) based on a board type string.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>type</code> - Board type string to look up</li>
    </ul>
    <p><strong>Returns:</strong> <code>"erm" | "jimi" | "ruptela" | "servision" | "jimi_iothub"</code></p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Reads <code>settings</code> from cache manager</li>
      <li>Checks each provider's board types array for a match</li>
      <li>Returns the matching provider name</li>
      <li>Throws error if no match found</li>
    </ul>
    <p><strong>Throws:</strong> <code>Error</code> with message "failed to get board maker from DB, type: {type}" if type not found</p>
    <p><strong>Example:</strong></p>
    <pre><code>const provider = get_board_maker_by_board_type('jimi_v2');
// Returns: 'jimi'</code></pre>

    <h3><code>get_board_maker_by_car(car: Car): BoardMakerResult</code></h3>
    <p>Determines the board provider for a vehicle by looking up its board via IMEI.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>car</code> - Car object with <code>carId</code> and <code>peripherals</code> array</li>
    </ul>
    <p><strong>Returns:</strong> <code>"erm" | "jimi" | "ruptela" | "servision" | "jimi_iothub"</code></p>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li>Extracts IMEI from <code>car.peripherals[0].mac</code></li>
      <li>Throws if IMEI not found</li>
      <li>Looks up board in cached <code>boards</code> array by matching <code>imei</code></li>
      <li>Throws if board not found or boards cache is empty</li>
      <li>Determines provider by checking board <code>type</code> against settings</li>
      <li>Returns matching provider or throws error</li>
    </ol>
    <p><strong>Throws:</strong></p>
    <ul>
      <li><code>Error</code> if IMEI not found: "IMEI not found for car number: {carId}"</li>
      <li><code>Error</code> if boards cache empty: "Boards are not in cache"</li>
      <li><code>Error</code> if board not found: "Board not found for imei: {imei}"</li>
      <li><code>Error</code> if provider not found: "failed to get board maker for board type: {type}"</li>
    </ul>
    <p><strong>Example:</strong></p>
    <pre><code>const car = {
  carId: '12345',
  peripherals: [{ mac: '123456789012345' }]
};
const provider = get_board_maker_by_car(car);
// Returns: 'erm' (or other provider based on board type)</code></pre>

    <h2>Type Definitions</h2>
    
    <h3><code>BoardProviderWithBoardTypes</code></h3>
    <pre><code>interface BoardProviderWithBoardTypes {
    board_provider: "erm" | "jimi" | "ruptela" | "servision" | "jimi_iothub";
    board_types: string[];
}</code></pre>

    <h3><code>BoardMakerResult</code></h3>
    <pre><code>type BoardMakerResult = "erm" | "jimi" | "ruptela" | "servision" | "jimi_iothub";</code></pre>

    <h2>Context</h2>
    <p>Used by services that need to route device logic based on board vendor. Common use cases:</p>
    <ul>
      <li>Determining which API to call for a specific vehicle's board</li>
      <li>Routing commands to the correct provider service</li>
      <li>Validating board compatibility with provider-specific features</li>
      <li>Filtering or grouping vehicles by board provider</li>
    </ul>
    <p><strong>Note:</strong> These functions rely on cached data (<code>settings</code> and <code>boards</code>), which should be populated via Firebase snapshots or Redis subscriptions during server initialization.</p>
    </div>
  </body>
</html>
