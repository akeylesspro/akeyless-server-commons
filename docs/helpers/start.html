<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/helpers/start.ts</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/helpers/start.ts</h1>
    
    <h2>Purpose</h2>
    <p>Express server bootstrap with standardized middleware setup, logging, error handling, and optional Redis initialization. Provides two initialization functions: <code>start_server</code> for basic server setup and <code>basic_init</code> for complete initialization including snapshot loading.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><code>express</code> - Express.js web framework</li>
      <li><code>cors</code> - CORS middleware for cross-origin requests</li>
      <li><a href="../managers/logger_manager.html"><code>logger</code></a> - Logging manager</li>
      <li><a href="global_helpers.html"><code>init_env_variables</code></a> - Environment validation helper</li>
      <li><a href="firebase_helpers.html"><code>init_snapshots</code></a> - Firebase/Redis snapshot initialization</li>
      <li>Middlewares:
        <ul>
          <li><a href="../middlewares/error_handling.html"><code>error_handler</code></a> - Global error handling middleware</li>
          <li><a href="../middlewares/global_mw.html"><code>request_logger</code></a> - Request logging middleware</li>
          <li><a href="../middlewares/trim_mw.html"><code>trim_body_middleware</code></a> - Request body trimming middleware</li>
        </ul>
      </li>
      <li><a href="redis/initialize.html"><code>init_redis</code></a> - Redis client initialization</li>
    </ul>

    <h2>Exports and behavior</h2>
    
    <h3><code>start_server(main_router: MainRouter, project_name: string, version: string, options?: AppOptions): Promise&lt;Express&gt;</code></h3>
    <p>Initializes and starts an Express server with common middleware and optional Redis initialization.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>main_router</code> - Function that receives Express app and sets up routes: <code>(app: Express) =&gt; void</code></li>
      <li><code>project_name</code> - Name of the project/service (for logging)</li>
      <li><code>version</code> - Version string (typically from package.json)</li>
      <li><code>options</code> - Optional configuration:
        <ul>
          <li><code>port</code> - Server port number (defaults to <code>process.env.port</code>)</li>
          <li><code>log_requests</code> - Request logging configuration</li>
          <li><code>initialize_redis</code> - Whether to initialize Redis (default: <code>true</code>)</li>
        </ul>
      </li>
    </ul>
    <p><strong>Returns:</strong> Promise resolving to the running Express app instance</p>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li>Creates Express app instance</li>
      <li>Validates <code>mode</code> environment variable (required)</li>
      <li>Sets port from options or environment variable</li>
      <li>Applies middleware in order: CORS, JSON parser, URL-encoded parser, trim middleware, request logger</li>
      <li>Applies main router (user-defined routes)</li>
      <li>Applies global error handler (must be last)</li>
      <li>Starts server listening on specified port</li>
      <li>Logs server startup information</li>
      <li>Optionally initializes Redis (if <code>initialize_redis</code> is true)</li>
      <li>Resolves with Express app instance</li>
    </ol>
    <p><strong>Error Handling:</strong> Redis initialization errors are logged as warnings but don't block server startup</p>

    <h3><code>basic_init(main_router: MainRouter, project_name: string, version: string, options?: AppOptions): Promise&lt;Express&gt;</code></h3>
    <p>Complete server initialization including snapshots. This is the recommended entry point for most services.</p>
    <p><strong>Parameters:</strong> Same as <code>start_server</code>, with additional <code>init_snapshot_options</code> in options</p>
    <p><strong>Returns:</strong> Promise resolving to the running Express app instance</p>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li>Calls <code>start_server</code> to initialize Express and start listening</li>
      <li>Calls <code>init_snapshots</code> to load Firebase/Redis snapshots</li>
      <li>Exits process with code 1 on any error</li>
    </ol>

    <h2>Middleware Order</h2>
    <p>The middleware is applied in this specific order:</p>
    <ol>
      <li><strong>CORS</strong> - Must be first to handle preflight requests</li>
      <li><strong>Body Parsers</strong> - Parse request bodies before other middleware</li>
      <li><strong>Trim Middleware</strong> - Clean user input early</li>
      <li><strong>Request Logger</strong> - Log requests after parsing</li>
      <li><strong>Main Router</strong> - User-defined routes</li>
      <li><strong>Error Handler</strong> - Must be last to catch all errors</li>
    </ol>

    <h2>Context</h2>
    <p>This module provides the standard bootstrapping pattern for all Akeyless microservices:</p>
    <ul>
      <li><strong>Consistent Setup</strong> - All services use the same middleware stack</li>
      <li><strong>Environment Validation</strong> - Ensures required environment variables are present</li>
      <li><strong>Request Logging</strong> - Configurable logging for debugging and monitoring</li>
      <li><strong>Error Handling</strong> - Global error handler catches unhandled errors</li>
      <li><strong>Redis Integration</strong> - Optional Redis initialization for caching</li>
      <li><strong>Snapshot Loading</strong> - <code>basic_init</code> ensures caches are populated before serving requests</li>
    </ul>
    <p><strong>Best Practices:</strong></p>
    <ul>
      <li>Use <code>basic_init</code> for most services (includes snapshot loading)</li>
      <li>Use <code>start_server</code> only if you need manual control over snapshot timing</li>
      <li>Always provide <code>project_name</code> and <code>version</code> for logging</li>
      <li>Configure <code>log_requests</code> appropriately for your environment</li>
    </ul>
    </div>
  </body>
</html>
