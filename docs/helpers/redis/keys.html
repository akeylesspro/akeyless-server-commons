<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/helpers/redis/keys.ts</title>
    <link rel="stylesheet" href="../../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/helpers/redis/keys.ts</h1>
    
    <h2>Purpose</h2>
    <p>Redis key and pattern utilities for building consistent key names and channel names. Provides helpers for document keys, collection patterns, update channels, and key scanning operations.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><code>ioredis</code> - Redis client library</li>
      <li><code>REDIS_UPDATES_PREFIX</code> - Prefix constant from <code>akeyless-types-commons</code> for update channels</li>
    </ul>

    <h2>Document and Collection Keys</h2>
    
    <h3><code>get_doc_key(collection: string, doc_id: string): string</code></h3>
    <p>Builds a Redis key for a specific document.</p>
    <p><strong>Returns:</strong> Redis key in format <code>"{collection}:{doc_id}"</code></p>
    <p><strong>Example:</strong> <code>get_doc_key('nx-users', 'user-123')</code> â†’ <code>'nx-users:user-123'</code></p>

    <h3><code>get_collection_keys(collection: string): string</code></h3>
    <p>Builds a Redis key pattern for all documents in a collection.</p>
    <p><strong>Returns:</strong> Redis pattern in format <code>"{collection}:*"</code></p>
    <p><strong>Usage:</strong> Used for pattern matching in SCAN operations and Pub/Sub subscription patterns</p>

    <h2>Channel Names</h2>
    
    <h3><code>get_channel(...args: string[]): string</code></h3>
    <p>Builds a Redis Pub/Sub channel name with update prefix.</p>
    <p><strong>Returns:</strong> Channel name in format <code>"{REDIS_UPDATES_PREFIX}:{args.join(':')}"</code></p>
    <p><strong>Usage:</strong> Used for Pub/Sub update channels with proper namespacing</p>

    <h2>Key Scanning</h2>
    
    <h3><code>scan_redis_keys(pattern: string, redis_publisher: Redis): Promise&lt;string[]&gt;</code></h3>
    <p>Scans Redis for all keys matching a pattern using SCAN command.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>pattern</code> - Redis key pattern (supports <code>*</code> wildcard)</li>
      <li><code>redis_publisher</code> - Redis client instance (commander)</li>
    </ul>
    <p><strong>Returns:</strong> Promise resolving to array of matching key strings</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Non-blocking alternative to <code>KEYS</code> command</li>
      <li>Safe for production use (doesn't block Redis)</li>
      <li>Processes keys in batches (100 keys per iteration)</li>
      <li>Iteratively calls SCAN until cursor returns to <code>"0"</code></li>
    </ul>

    <h2>Context</h2>
    <p>These utilities ensure consistent key naming across the application:</p>
    <ul>
      <li><strong>Consistency</strong> - All keys follow the same pattern</li>
      <li><strong>Namespacing</strong> - Collections are clearly separated</li>
      <li><strong>Pattern Matching</strong> - Easy to find related keys</li>
      <li><strong>Pub/Sub</strong> - Update channels are properly namespaced</li>
    </ul>
    </div>
  </body>
</html>
