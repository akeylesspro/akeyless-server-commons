<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/helpers/email_helpers.ts</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/helpers/email_helpers.ts</h1>
    
    <h2>Purpose</h2>
    <p>Email sending functionality using SendGrid API, with comprehensive attachment support from files, buffers, or URLs. Includes automatic audit logging and group-based recipient management.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><code>@sendgrid/mail</code> - SendGrid email API client</li>
      <li><code>fs</code> and <code>path</code> - File system operations for reading files</li>
      <li>Firebase helpers:
        <ul>
          <li><a href="firebase_helpers.html"><code>add_audit_record</code></a> - Logs email operations to audit trail</li>
          <li><a href="firebase_helpers.html"><code>get_document_by_id</code></a> - Fetches email settings from Firestore</li>
          <li><a href="global_helpers.html"><code>ignore_ssl_request</code></a> - HTTP request helper for downloading attachments</li>
        </ul>
      </li>
      <li>Types: <a href="../types/interfaces/email.html"><code>EmailData</code></a>, <a href="../types/interfaces/email.html"><code>EmailSettings</code></a>, <a href="../types/interfaces/email.html"><code>EmailAttachment</code></a> from <code>src/types/interfaces/email</code></li>
      <li><a href="../managers/logger_manager.html"><code>logger</code></a> manager - Error and debug logging</li>
    </ul>

    <h2>Attachment Creation Utilities</h2>
    
    <h3><code>create_attachment_from_file(file_path: string, filename?: string, disposition: "attachment" | "inline" = "attachment"): Promise&lt;EmailAttachment&gt;</code></h3>
    <p>Creates an email attachment from a local file path.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>file_path</code> - Full path to the file to attach</li>
      <li><code>filename</code> - Optional custom filename (defaults to basename of file_path)</li>
      <li><code>disposition</code> - <code>"attachment"</code> (download) or <code>"inline"</code> (display in email body), defaults to <code>"attachment"</code></li>
    </ul>
    <p><strong>Returns:</strong> Promise resolving to <code>EmailAttachment</code> object with base64 content</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Reads file synchronously using <code>fs.readFileSync</code></li>
      <li>Converts content to base64</li>
      <li>Detects MIME type from file extension</li>
      <li>Returns attachment object ready for SendGrid</li>
    </ul>
    <p><strong>Throws:</strong> Re-throws file read errors with context</p>

    <h3><code>create_attachment_from_buffer(buffer: Buffer | Uint8Array, filename: string, mime_type: string, disposition: "attachment" | "inline" = "attachment"): EmailAttachment</code></h3>
    <p>Creates an email attachment from an in-memory buffer.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>buffer</code> - Buffer or Uint8Array containing file data</li>
      <li><code>filename</code> - Filename for the attachment</li>
      <li><code>mime_type</code> - MIME type string (e.g., "application/pdf", "image/png")</li>
      <li><code>disposition</code> - <code>"attachment"</code> or <code>"inline"</code>, defaults to <code>"attachment"</code></li>
    </ul>
    <p><strong>Returns:</strong> <code>EmailAttachment</code> object with base64 content</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Converts buffer to base64 string</li>
      <li>No file I/O required, suitable for dynamically generated content</li>
    </ul>

    <h3><code>create_attachment_from_url(url: string, filename: string): Promise&lt;EmailAttachment&gt;</code></h3>
    <p>Downloads a file from a URL and creates an email attachment.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>url</code> - HTTP/HTTPS URL to download from</li>
      <li><code>filename</code> - Filename for the attachment</li>
    </ul>
    <p><strong>Returns:</strong> Promise resolving to <code>EmailAttachment</code> object</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Uses <code>ignore_ssl_request</code> helper (supports SSL verification bypass in QA mode)</li>
      <li>Downloads binary data with 20-second timeout</li>
      <li>Detects content type from response headers (defaults to "application/pdf")</li>
      <li>Converts to base64 and returns attachment object</li>
    </ul>
    <p><strong>Throws:</strong> Re-throws download errors with context</p>

    <h3><code>get_mime_type(file_path: string): string</code> (Internal)</h3>
    <p>Maps file extensions to MIME types.</p>
    <p><strong>Supported Extensions:</strong></p>
    <ul>
      <li>Documents: <code>.pdf</code>, <code>.doc</code>, <code>.docx</code>, <code>.xls</code>, <code>.xlsx</code>, <code>.ppt</code>, <code>.pptx</code>, <code>.txt</code>, <code>.csv</code>, <code>.json</code>, <code>.xml</code></li>
      <li>Archives: <code>.zip</code>, <code>.rar</code>, <code>.7z</code></li>
      <li>Images: <code>.jpg</code>, <code>.jpeg</code>, <code>.png</code>, <code>.gif</code>, <code>.bmp</code>, <code>.svg</code></li>
      <li>Media: <code>.mp3</code>, <code>.mp4</code>, <code>.avi</code>, <code>.mov</code></li>
    </ul>
    <p><strong>Returns:</strong> MIME type string or <code>"application/octet-stream"</code> for unknown extensions</p>

    <h2>Email Sending</h2>
    
    <h3><code>send_email(email_data: EmailData, options?: { debug?: boolean }): Promise&lt;void&gt;</code></h3>
    <p>Sends an email via SendGrid with support for groups, attachments, and audit logging.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>email_data</code> - <code>EmailData</code> object containing:
        <ul>
          <li><code>to</code> - String or array of recipient email addresses (optional if <code>group_name</code> provided)</li>
          <li><code>cc</code> - String or array of CC addresses (optional)</li>
          <li><code>group_name</code> - Name of email group from settings (optional if <code>to</code> provided)</li>
          <li><code>from</code> - Sender email (optional, uses <code>default_from</code> from settings)</li>
          <li><code>subject</code> - Email subject line</li>
          <li><code>body_html</code> - HTML email body (optional if <code>body_plain_text</code> provided)</li>
          <li><code>body_plain_text</code> - Plain text email body (optional if <code>body_html</code> provided)</li>
          <li><code>attachments</code> - Array of <code>EmailAttachment</code> objects (optional)</li>
          <li><code>entity_for_audit</code> - Entity identifier for audit logging</li>
        </ul>
      </li>
      <li><code>options</code> - Optional configuration:
        <ul>
          <li><code>debug</code> - Enable debug logging (default: <code>false</code>)</li>
        </ul>
      </li>
    </ul>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li>Fetches email settings from Firestore (<code>nx-settings/emails</code> document)</li>
      <li>Validates that either <code>to</code> or <code>group_name</code> is provided</li>
      <li>Validates that either <code>body_html</code> or <code>body_plain_text</code> is provided</li>
      <li>If <code>group_name</code> provided: validates group exists, merges recipients and CC</li>
      <li>Merges default CC addresses from settings</li>
      <li>Sets SendGrid API key from settings</li>
      <li>Builds SendGrid message payload (HTML or text based on available body)</li>
      <li>Sends email via SendGrid API</li>
      <li>Validates response status code (expects 202)</li>
      <li>Writes audit record to <code>nx-audit</code> collection</li>
      <li>Optionally logs success/failure details</li>
    </ol>
    <p><strong>Throws:</strong></p>
    <ul>
      <li><code>"must supply a 'group_name' or 'to' value"</code> - Missing recipients</li>
      <li><code>"must supply a 'body_plain_text' or 'html' value"</code> - Missing body content</li>
      <li><code>"must supply a valid 'group_name'"</code> - Invalid group name</li>
      <li>SendGrid API errors (status code != 202)</li>
    </ul>
    <p><strong>Error Handling:</strong> Logs errors but does not throw (allows graceful failure)</p>

    <h2>Email Settings Structure</h2>
    <p>Email settings are stored in Firestore at <code>nx-settings/emails</code> with the following structure:</p>
    <pre><code>interface EmailSettings {
  sendgrid_api_key: string;
  default_from: string;
  default_cc: string[];
  groups: {
    [groupName: string]: {
      to: string[];
      cc?: string[];
    };
  };
}</code></pre>

    <h2>Context</h2>
    <p>Provides a consistent email flow with:</p>
    <ul>
      <li><strong>Centralized Configuration</strong> - Settings stored in Firestore, easy to update without code changes</li>
      <li><strong>Group Management</strong> - Predefined recipient groups for common use cases</li>
      <li><strong>Attachment Support</strong> - Multiple ways to attach files (local, buffer, URL)</li>
      <li><strong>Audit Trail</strong> - All emails logged to <code>nx-audit</code> collection for compliance</li>
      <li><strong>Error Resilience</strong> - Graceful error handling with optional debug logging</li>
    </ul>
    <p><strong>Common use cases:</strong></p>
    <ul>
      <li>User registration emails</li>
      <li>Password reset emails</li>
      <li>System notifications</li>
      <li>Report generation and distribution</li>
      <li>Invoice and document delivery</li>
    </ul>
    </div>
  </body>
</html>
