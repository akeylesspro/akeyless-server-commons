<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/helpers/notification_helpers.ts</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/helpers/notification_helpers.ts</h1>
    
    <h2>Purpose</h2>
    <p>SMS and push notification helpers for sending messages to users via multiple SMS providers (Multisend, Twilio, Monogoto) and Firebase Cloud Messaging (FCM). Includes intelligent provider selection, SMS group expansion, event-based push notifications, and comprehensive audit logging.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><code>axios</code> - HTTP client for SMS provider APIs</li>
      <li><code>FormData</code> - Form data encoding for Multisend API</li>
      <li><code>Twilio</code> - Twilio SDK for international SMS</li>
      <li>Firebase <code>messaging</code> - FCM push notification service</li>
      <li><a href="../managers/cache_manager.html"><code>cache_manager</code></a> - Accesses cached collections and settings</li>
      <li><a href="../managers/logger_manager.html"><code>logger</code></a> - Logging utility</li>
      <li><a href="../managers/translation_manager.html"><code>translation_manager</code></a> - Translation lookup for push notifications</li>
      <li>Firebase helpers: <a href="firebase_helpers.html"><code>add_document</code></a>, <a href="firebase_helpers.html"><code>add_audit_record</code></a>, <a href="firebase_helpers.html"><code>get_nx_settings</code></a></li>
      <li>Phone utilities from <a href="phone_number_helpers.html"><code>phone_number_helpers</code></a></li>
    </ul>

    <h2>SMS Provider Selection</h2>
    <p>The system automatically selects SMS provider based on recipient number:</p>
    <ol>
      <li><strong>ICCID Numbers</strong> (19-22 digits starting with <code>89</code>) → <strong>Monogoto</strong> - Used for device-to-device SMS via SIM cards</li>
      <li><strong>International Numbers</strong> (not Israeli, not Thai) → <strong>Twilio</strong> - Used for international SMS delivery</li>
      <li><strong>Israeli/Thai Numbers</strong> → <strong>Multisend</strong> - Default provider for local Israeli numbers</li>
    </ol>

    <h2>SMS Functions</h2>
    
    <h3><code>send_sms(recepient: string, text: string, entity_for_audit: string, details?: TObject&lt;any&gt;): Promise&lt;void&gt;</code></h3>
    <p>Sends SMS to recipient(s) with automatic provider selection and group expansion.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>recepient</code> - Phone number or SMS group name from settings</li>
      <li><code>text</code> - SMS message text</li>
      <li><code>entity_for_audit</code> - Entity identifier for audit logging</li>
      <li><code>details</code> - Optional additional details for logging</li>
    </ul>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li><strong>Group Expansion:</strong> Checks if recipient matches SMS group, expands to all numbers in group</li>
      <li><strong>Deduplication:</strong> Removes duplicate phone numbers</li>
      <li><strong>Parallel Sending:</strong> Sends SMS to all recipients in parallel</li>
      <li><strong>Provider Selection:</strong> Automatically selects provider based on number format (ICCID → Monogoto, International → Twilio, Otherwise → Multisend)</li>
      <li><strong>Audit Logging:</strong> Writes audit record for each successful send</li>
    </ol>
    <p><strong>Throws:</strong> Error message if any SMS send fails</p>

    <h2>Push Notifications</h2>
    
    <h3><code>push_event_to_mobile_users(event: EventFromDevice): Promise&lt;void&gt;</code></h3>
    <p>Sends push notifications to mobile app users for device events.</p>
    <p><strong>Behavior:</strong></p>
    <ol>
      <li>Reads cached collections: <code>units</code>, <code>usersUnits</code>, <code>mobile_users_app_pro</code>, <code>app_pro_extra_pushes</code></li>
      <li>Resolves main driver, secondary drivers, and extra drivers based on vehicle and user relationships</li>
      <li>Respects disabled events per user</li>
      <li>Uses translations to build title/body based on user language</li>
      <li>Sends FCM messages via <code>send_fcm_message</code></li>
    </ol>

    <h3><code>send_fcm_message(title: string, body: string, fcm_tokens: string[], custom_sound?: string): Promise&lt;{success: boolean, response: string}&gt;</code></h3>
    <p>Sends Firebase Cloud Messaging (FCM) push notifications to multiple devices.</p>
    <p><strong>Parameters:</strong></p>
    <ul>
      <li><code>title</code> - Notification title</li>
      <li><code>body</code> - Notification body text</li>
      <li><code>fcm_tokens</code> - Array of FCM registration tokens</li>
      <li><code>custom_sound</code> - Optional custom sound file name</li>
    </ul>
    <p><strong>Returns:</strong> Promise resolving to result object with success status and response details</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Deduplicates FCM tokens</li>
      <li>Creates multicast FCM message with Android/APNS payload</li>
      <li>Logs success/failure summary</li>
    </ul>

    <h2>Context</h2>
    <p>This module provides comprehensive notification capabilities:</p>
    <ul>
      <li><strong>Multi-Provider SMS</strong> - Automatic provider selection based on recipient</li>
      <li><strong>SMS Groups</strong> - Send to multiple recipients via group names</li>
      <li><strong>Event-Based Push</strong> - Automatic push notifications for device events</li>
      <li><strong>User Filtering</strong> - Respects user preferences for disabled events</li>
      <li><strong>Multi-Language</strong> - Supports Hebrew, English, and Russian</li>
      <li><strong>Audit Trail</strong> - All SMS sends logged for compliance</li>
    </ul>
    </div>
  </body>
</html>
