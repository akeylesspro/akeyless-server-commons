<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>akeyless-server-commons - Project Summary</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>akeyless-server-commons - Project Summary</h1>

    <h2>Overview</h2>
    <p><code>akeyless-server-commons</code> is a comprehensive Node.js/TypeScript server utilities package that provides shared functionality for Akeyless microservices. It offers a standardized set of helpers, managers, middlewares, and types that ensure consistency across all server-side applications.</p>
    <p><strong>Version:</strong> 1.0.168<br />
    <strong>Repository:</strong> <a href="https://github.com/akeylesspro/akeyless-server-commons">GitHub</a></p>

    <h2>What This Package Contains</h2>

    <h3>ğŸ“¦ Package Structure</h3>
    <p>The package exports four main modules:</p>
    <ul>
      <li><a href="helpers/index.html"><code>./helpers</code></a> - Utility functions and service integrations</li>
      <li><a href="managers/index.html"><code>./managers</code></a> - Singleton managers for shared state</li>
      <li><a href="middlewares/index.html"><code>./middlewares</code></a> - Express middleware for common server needs</li>
      <li><a href="types/index.html"><code>./types</code></a> - Shared TypeScript types, interfaces, and enums</li>
    </ul>

    <h2>Core Components</h2>

    <h3>ğŸ”§ Helpers (<a href="helpers/index.html">./helpers</a>)</h3>
    <p>Stateless utility functions organized by domain:</p>

    <h4>Infrastructure & Bootstrap</h4>
    <ul>
      <li><a href="helpers/global_helpers.html"><code>global_helpers</code></a> - Environment validation, JSON responses, service URLs, geocoding, trimming utilities</li>
      <li><a href="helpers/start.html"><code>start</code></a> - Express server bootstrap with middleware setup, Redis initialization, snapshot loading</li>
      <li><a href="helpers/firebase_helpers.html"><code>firebase_helpers</code></a> - Firebase Admin SDK integration, Firestore CRUD operations, real-time snapshots, storage, audit logging</li>
    </ul>

    <h4>Data & Communication</h4>
    <ul>
      <li><a href="helpers/email_helpers.html"><code>email_helpers</code></a> - SendGrid email sending with attachment support</li>
      <li><a href="helpers/notification_helpers.html"><code>notification_helpers</code></a> - SMS (Multisend/Twilio/Monogoto) and FCM push notifications</li>
      <li><a href="helpers/phone_number_helpers.html"><code>phone_number_helpers</code></a> - Phone number normalization, validation, SIM provider detection</li>
    </ul>

    <h4>Domain-Specific</h4>
    <ul>
      <li><a href="helpers/login_helpers.html"><code>login_helpers</code></a> - User lookup by email/phone/UID</li>
      <li><a href="helpers/time_helpers.html"><code>time_helpers</code></a> - Timestamp conversion and formatting utilities</li>
      <li><a href="helpers/location_helpers.html"><code>location_helpers</code></a> - Geospatial distance calculations and Google Maps URLs</li>
      <li><a href="helpers/tasks_helpers.html"><code>tasks_helpers</code></a> - Task execution orchestration with caching and persistence</li>
      <li><a href="helpers/boards_helpers.html"><code>boards_helpers</code></a> - Board provider resolution utilities</li>
    </ul>

    <h4>Redis Integration</h4>
    <ul>
      <li><a href="helpers/redis/initialize.html"><code>redis/initialize</code></a> - Redis client setup (commander/listener pattern)</li>
      <li><a href="helpers/redis/keys.html"><code>redis/keys</code></a> - Key pattern utilities and SCAN operations</li>
      <li><a href="helpers/redis/snapshot.html"><code>redis/snapshot</code></a> - Redis-backed cache hydration with Firebase fallback</li>
    </ul>

    <h3>ğŸ¯ Managers (<a href="managers/index.html">./managers</a>)</h3>
    <p>Singleton instances providing shared state:</p>
    <ul>
      <li><a href="managers/cache_manager.html"><code>cache_manager</code></a> - In-memory cache for arrays and objects (used across helpers)</li>
      <li><a href="managers/logger_manager.html"><code>logger_manager</code></a> - Timestamped logging with Axios-aware error handling, table formatting</li>
      <li><a href="managers/translation_manager.html"><code>translation_manager</code></a> - Translation cache and lookup for UI/SMS/email messages</li>
    </ul>

    <h3>ğŸ›¡ï¸ Middlewares (<a href="middlewares/index.html">./middlewares</a>)</h3>
    <p>Express middleware for request handling:</p>
    <ul>
      <li><a href="middlewares/global_mw.html"><code>global_mw</code></a> - Request validation (<code>mandatory</code>, <code>optional</code>), request logging</li>
      <li><a href="middlewares/auth_mw.html"><code>auth_mw</code></a> - Authentication middleware (<code>verify_user_auth</code>, <code>nx_user_login</code>, <code>client_login</code>)</li>
      <li><a href="middlewares/error_handling.html"><code>error_handling</code></a> - Async error wrapper and global error handler</li>
      <li><a href="middlewares/trim_mw.html"><code>trim_mw</code></a> - Request body string trimming middleware</li>
    </ul>

    <h3>ğŸ“ Types (<a href="types/index.html">./types</a>)</h3>
    <p>Shared TypeScript definitions:</p>
    <ul>
      <li><a href="types/types/global.html"><code>types/global</code></a> - Core types (MW, Service, Route, JsonOK, JsonFailed, etc.)</li>
      <li><a href="types/types/firebase_types.html"><code>types/firebase_types</code></a> - Firestore query and snapshot type definitions</li>
      <li><a href="types/interfaces/global.html"><code>interfaces/global</code></a> - Middleware and app option interfaces</li>
      <li><a href="types/interfaces/email.html"><code>interfaces/email</code></a> - Email data models (EmailData, EmailSettings, EmailAttachment)</li>
      <li><a href="types/enums/global.html"><code>enums/global</code></a> - Enums (SimProvider, NxServiceName, NxServiceNameMap)</li>
    </ul>

    <h2>What This Package Does</h2>

    <h3>Primary Functions</h3>
    <ol>
      <li><strong>Server Bootstrap</strong> - Standardized Express server initialization with common middleware</li>
      <li><strong>Firebase Integration</strong> - Complete Firestore/Storage/Auth/Messaging integration</li>
      <li><strong>Caching System</strong> - In-memory cache with Redis and Firebase snapshot support</li>
      <li><strong>Communication</strong> - Email (SendGrid) and SMS/Push notification services</li>
      <li><strong>Request Handling</strong> - Validation, authentication, logging, error handling middleware</li>
      <li><strong>Data Utilities</strong> - Phone normalization, time formatting, geocoding, task orchestration</li>
    </ol>

    <h3>Key Features</h3>
    <ul>
      <li>âœ… <strong>Environment Validation</strong> - Validates required environment variables on startup</li>
      <li>âœ… <strong>Real-time Data Sync</strong> - Firebase snapshots and Redis Pub/Sub for live cache updates</li>
      <li>âœ… <strong>Multi-provider SMS</strong> - Automatic routing (Multisend/Twilio/Monogoto) based on phone number</li>
      <li>âœ… <strong>Audit Logging</strong> - Built-in audit trail for emails, SMS, and operations</li>
      <li>âœ… <strong>Translation Support</strong> - Multi-language support for notifications and UI</li>
      <li>âœ… <strong>Type Safety</strong> - Comprehensive TypeScript types for all APIs</li>
    </ul>

    <h2>How to Use</h2>

    <h3>Installation</h3>
    <pre><code>npm install akeyless-server-commons</code></pre>

    <h3>Basic Usage</h3>

    <h4>Import Modules</h4>
    <pre><code>// ESM
import { helpers, managers, middlewares, types } from 'akeyless-server-commons';

// CJS
const { helpers, managers, middlewares, types } = require('akeyless-server-commons');

// Or import specific modules
import { helpers } from 'akeyless-server-commons/helpers';
import { managers } from 'akeyless-server-commons/managers';
import { middlewares } from 'akeyless-server-commons/middlewares';
import { types } from 'akeyless-server-commons/types';</code></pre>

    <h4>Server Bootstrap Example</h4>
    <pre><code>import express from 'express';
import { helpers } from 'akeyless-server-commons/helpers';
import { version } from '../package.json';

const mainRouter = (app: express.Express) => {
  app.get('/health', (req, res) => {
    res.json({ status: 'ok' });
  });
};

// Start server with snapshots and Redis
await helpers.basic_init(mainRouter, 'my-service', version, {
  port: 3000,
  log_requests: { url: true, body: true },
  init_snapshot_options: { subscription_type: 'firebase' },
  initialize_redis: true
});</code></pre>

    <h4>Using Helpers</h4>
    <pre><code>import { helpers } from 'akeyless-server-commons/helpers';
import { managers } from 'akeyless-server-commons/managers';

// Environment validation
const env = helpers.init_env_variables(['mode', 'port', 'project_id']);

// JSON responses
res.json(helpers.json_ok({ data: 'success' }));
res.json(helpers.json_failed(new Error('Something went wrong')));

// Firebase operations
const user = await helpers.query_document('nx-users', 'email', '==', 'user@example.com');
await helpers.add_document('nx-users', { name: 'John', email: 'john@example.com' });

// Email sending
await helpers.send_email({
  to: 'user@example.com',
  subject: 'Welcome',
  body_html: '&lt;h1&gt;Welcome!&lt;/h1&gt;',
  entity_for_audit: 'user_registration'
});

// SMS sending
await helpers.send_sms('+972501234567', 'Your code is 1234', 'user_verification');

// Cache access
const settings = managers.cache_manager.getObjectData('nx-settings');
managers.logger.log('Operation completed', { userId: '123' });</code></pre>

    <h4>Using Middlewares</h4>
    <pre><code>import { middlewares } from 'akeyless-server-commons/middlewares';

// Request validation
app.post('/api/users',
  middlewares.mandatory({
    body: [
      { key: 'email', type: 'string', length: 5 },
      { key: 'name', type: 'string' }
    ]
  }),
  middlewares.nx_user_login,
  async (req, res) => {
    // req.body.user is available here
    res.json(helpers.json_ok({ user: req.body.user }));
  }
);

// Auth protection
app.get('/api/protected',
  middlewares.verify_user_auth,
  (req, res) => {
    // req.body.firebase_user is available
    res.json(helpers.json_ok({ user: req.body.firebase_user }));
  }
);</code></pre>

    <h4>Using Managers</h4>
    <pre><code>import { managers } from 'akeyless-server-commons/managers';

// Cache operations
managers.cache_manager.setObjectData('my-key', { data: 'value' });
const data = managers.cache_manager.getObjectData('my-key');
managers.cache_manager.setArrayData('my-list', [1, 2, 3]);
const list = managers.cache_manager.getArrayData('my-list');

// Logging
managers.logger.log('Info message', { additional: 'data' });
managers.logger.error('Error occurred', error);
managers.logger.warn('Warning message');

// Translations
const translation = managers.translation_manager.get_translation(
  'push_notifications',
  'he',
  'title',
  'event_from_device'
);</code></pre>

    <h2>Environment Variables</h2>

    <h3>Required Variables</h3>
    <p>The package requires various environment variables depending on usage:</p>

    <h4>Firebase (Required for Firebase helpers)</h4>
    <ul>
      <li><code>type</code>, <code>project_id</code>, <code>private_key_id</code>, <code>private_key</code>, <code>client_email</code>, <code>client_id</code>, <code>auth_uri</code>, <code>token_uri</code>, <code>auth_provider_x509_cert_url</code>, <code>client_x509_cert_url</code>, <code>universe_domain</code></li>
    </ul>

    <h4>Server Bootstrap</h4>
    <ul>
      <li><code>mode</code> - Environment mode (<code>prod</code>, <code>qa</code>, <code>local</code>)</li>
      <li><code>port</code> - Server port (optional, can be passed to <code>start_server</code>)</li>
    </ul>

    <h4>Redis (Optional)</h4>
    <ul>
      <li><code>redis_ip</code> - Redis server IP address</li>
    </ul>

    <h4>Google Services (For geocoding)</h4>
    <ul>
      <li>Configured in <code>nx-settings</code> collection: <code>google.geocode_api_key</code></li>
    </ul>

    <h4>Email (SendGrid)</h4>
    <ul>
      <li>Configured in <code>nx-settings</code> collection: <code>emails.sendgrid_api_key</code></li>
    </ul>

    <h4>SMS Providers</h4>
    <ul>
      <li>Configured in <code>nx-settings</code> collection:
        <ul>
          <li><code>sms_provider.multisend</code> (user, password, from)</li>
          <li><code>sms_provider.twilio</code> (account_sid, token, messaging_service_sid)</li>
          <li><code>sms_provider.monogoto</code> (user, password, from)</li>
        </ul>
      </li>
    </ul>

    <h2>Project Architecture</h2>

    <h3>Module Dependencies</h3>
    <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Helpers   â”‚â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                 â”œâ”€â”€â–º Managers (cache, logger, translation)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Middlewares â”‚â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â”€â–º Helpers (for JSON responses, auth, trimming)

All modules â”€â”€â”€â”€â–º Types (for consistent API shapes)</code></pre>

    <h3>Data Flow</h3>
    <ol>
      <li><strong>Server Startup</strong> â†’ <a href="helpers/start.html"><code>start.ts</code></a> initializes Express, Redis, Firebase snapshots</li>
      <li><strong>Snapshot Loading</strong> â†’ Firebase/Redis snapshots populate <a href="managers/cache_manager.html"><code>cache_manager</code></a></li>
      <li><strong>Request Handling</strong> â†’ Middlewares validate/auth/log â†’ Route handlers use helpers</li>
      <li><strong>Operations</strong> â†’ Helpers use managers for cache/logging/translations</li>
      <li><strong>Audit Trail</strong> â†’ Operations write to <code>nx-audit</code> collection</li>
    </ol>

    <h2>Common Use Cases</h2>

    <h3>1. Starting a New Microservice</h3>
    <pre><code>import { helpers } from 'akeyless-server-commons/helpers';
import { version } from './package.json';

const router = (app: express.Express) => {
  // Define your routes
};

await helpers.basic_init(router, 'my-service', version);</code></pre>

    <h3>2. Querying Firebase Data</h3>
    <pre><code>import { helpers } from 'akeyless-server-commons/helpers';

// Get single document
const user = await helpers.query_document('nx-users', 'email', '==', 'user@example.com');

// Get multiple documents
const users = await helpers.query_documents('nx-users', 'status', '==', 'active');

// Get by ID
const doc = await helpers.get_document_by_id('nx-users', 'user-id-123');</code></pre>

    <h3>3. Sending Notifications</h3>
    <pre><code>import { helpers } from 'akeyless-server-commons/helpers';

// Send SMS
await helpers.send_sms('+972501234567', 'Your verification code: 1234', 'user_verification');

// Send push notification
await helpers.send_fcm_message(
  'New Message',
  'You have a new notification',
  ['fcm-token-1', 'fcm-token-2']
);

// Send email
await helpers.send_email({
  to: 'user@example.com',
  subject: 'Welcome',
  body_html: '&lt;h1&gt;Welcome to our service!&lt;/h1&gt;',
  entity_for_audit: 'user_registration'
});</code></pre>

    <h3>4. Using Cache</h3>
    <pre><code>import { managers } from 'akeyless-server-commons/managers';

// Cache is populated by Firebase snapshots on startup
const settings = managers.cache_manager.getObjectData('nx-settings');
const users = managers.cache_manager.getArrayData('users');</code></pre>

    <h3>5. Request Validation</h3>
    <pre><code>import { middlewares } from 'akeyless-server-commons/middlewares';

app.post('/api/data',
  middlewares.mandatory({
    body: [
      { key: 'name', type: 'string', length: 3 },
      { key: 'age', type: 'number' },
      { key: 'tags', type: 'array', array_types: ['string'] }
    ]
  }),
  (req, res) => {
    // req.body is validated here
  }
);</code></pre>

    <h2>Build & Deploy</h2>

    <h3>Build</h3>
    <pre><code>npm run build        # Build both CJS and ESM
npm run build:cjs    # Build CommonJS only
npm run build:esm    # Build ESM only</code></pre>

    <h3>Deploy</h3>
    <pre><code>npm run deploy       # Build, version patch, publish
npm run deployTest   # Build, version prerelease, publish with 'test' tag</code></pre>

    <h2>Documentation Structure</h2>
    <p>This documentation is organized as follows:</p>
    <ul>
      <li><a href="README.html"><code>docs/README.html</code></a> - Project overview and cross-module relationships</li>
      <li><a href="summary.html"><code>docs/summary.html</code></a> - This comprehensive summary</li>
      <li><a href="helpers/index.html"><code>docs/helpers/</code></a> - Detailed documentation for each helper module</li>
      <li><a href="managers/index.html"><code>docs/managers/</code></a> - Documentation for cache, logger, and translation managers</li>
      <li><a href="middlewares/index.html"><code>docs/middlewares/</code></a> - Middleware documentation</li>
      <li><a href="types/index.html"><code>docs/types/</code></a> - Type definitions documentation</li>
    </ul>
    <p>Each folder contains:</p>
    <ul>
      <li><code>README.html</code> - Overview of the folder contents</li>
      <li>Individual <code>.html</code> and <code>.md</code> files for each module</li>
    </ul>

    <h2>Key Design Patterns</h2>
    <ol>
      <li><strong>Singleton Managers</strong> - Shared state via singleton pattern (cache, logger, translations)</li>
      <li><strong>Snapshot Pattern</strong> - Real-time data sync via Firebase snapshots or Redis Pub/Sub</li>
      <li><strong>Helper Functions</strong> - Stateless utility functions organized by domain</li>
      <li><strong>Middleware Chain</strong> - Express middleware for cross-cutting concerns</li>
      <li><strong>Type Safety</strong> - Comprehensive TypeScript types for all public APIs</li>
    </ol>

    <h2>Best Practices</h2>
    <ol>
      <li><strong>Always validate environment variables</strong> using <code>init_env_variables()</code> on startup</li>
      <li><strong>Use cache_manager</strong> for frequently accessed data (populated by snapshots)</li>
      <li><strong>Use logger</strong> for all logging (provides consistent timestamp formatting)</li>
      <li><strong>Use json_ok/json_failed</strong> for consistent API responses</li>
      <li><strong>Use middlewares</strong> for request validation and authentication</li>
      <li><strong>Use types</strong> from the package for consistent API shapes</li>
    </ol>

    <h2>Support & Contribution</h2>
    <ul>
      <li><strong>Repository:</strong> <a href="https://github.com/akeylesspro/akeyless-server-commons">GitHub</a></li>
      <li><strong>Issues:</strong> Report issues on GitHub</li>
      <li><strong>Version:</strong> Check <code>package.json</code> for current version</li>
    </ul>

    <h2>Related Packages</h2>
    <ul>
      <li><strong><code>akeyless-types-commons</code></strong> - Shared TypeScript types used by this package</li>
    </ul>

    <hr />
    <p>For detailed documentation on specific modules, see the <a href="README.html">full documentation index</a>.</p>
    </div>
  </body>
</html>
