{
  "metadata": {
    "source_file": "src/middlewares/auth_mw.ts",
    "path": "docs/middlewares/auth_mw.md",
    "type": "module"
  },
  "purpose": "Authentication middleware for Firebase users, NX users, and API clients. Provides three middleware functions that verify authentication tokens and attach authenticated user/client data to the request object for use in route handlers.",
  "dependencies": [
    "verify_token - Verifies Firebase authentication tokens from Authorization header",
    "json_failed - Creates standardized error response objects",
    "query_document_optional - Queries Firestore for optional document retrieval",
    "get_user_by_identifier - Retrieves NX user by phone number or email",
    "logger - Logging manager for error tracking",
    "MW - Express middleware type definition",
    "NxUser - NX user type from akeyless-types-commons",
    "Client - API client type from akeyless-types-commons"
  ],
  "sections": [
    {
      "title": "Exports",
      "exports": [
        {
          "name": "verify_user_auth",
          "type": "function",
          "description": "Firebase user authentication middleware that validates bearer tokens from the Authorization header.",
          "behavior": [
            "Extracts the Authorization header from the request",
            "Verifies the Firebase authentication token using verify_token",
            "On success: Attaches the decoded Firebase user object to req.body.firebase_user and calls next()",
            "On failure: Logs the error using logger.error, responds with HTTP 403 status and a JSON error response using json_failed"
          ],
          "examples": [
            {
              "code": "app.get('/protected-route', verify_user_auth, (req, res) => {\n  // req.body.firebase_user is available here\n  const user = req.body.firebase_user;\n});",
              "language": "typescript"
            }
          ],
          "error_handling": [
            "Catches any errors during token verification",
            "Returns 403 Forbidden status with error details in JSON format"
          ]
        },
        {
          "name": "nx_user_login",
          "type": "function",
          "description": "NX user login middleware that validates Firebase tokens and resolves the corresponding NX user from the database.",
          "behavior": [
            "Extracts the Authorization header from the request",
            "Verifies the Firebase authentication token to get user data",
            "Validates that the token contains either a phone_number or email field",
            "Queries the NX users collection using get_user_by_identifier with the phone number or email",
            "Constructs a full_name field by concatenating first_name and last_name (trimmed)",
            "On success: Attaches the NX user object with full_name to req.body.user as NxUser type and calls next()",
            "On failure: Responds with HTTP 403 status and a JSON error response"
          ],
          "examples": [
            {
              "code": "app.post('/api/user-data', nx_user_login, (req, res) => {\n  // req.body.user is available here with full_name property\n  const nxUser = req.body.user;\n});",
              "language": "typescript"
            }
          ],
          "error_handling": [
            "Returns 403 Forbidden if token is invalid, missing identifiers, or user not found",
            "Error messages include specific details about what failed"
          ]
        },
        {
          "name": "client_login",
          "type": "function",
          "description": "API client authentication middleware that validates API tokens against the nx-clients collection.",
          "behavior": [
            "Extracts the Authorization header from the request",
            "Validates that the token exists (throws error if missing)",
            "Queries the nx-clients collection using query_document_optional with field api_token matching the provided token",
            "On success: Attaches the client document to req.body.client as Client type and calls next()",
            "On failure: Responds with HTTP 403 status and a JSON error response"
          ],
          "examples": [
            {
              "code": "app.post('/api/client-endpoint', client_login, (req, res) => {\n  // req.body.client is available here\n  const client = req.body.client;\n});",
              "language": "typescript"
            }
          ],
          "error_handling": [
            "Returns 403 Forbidden if token is missing or no matching client is found",
            "Error messages include the token value for debugging (in error message)"
          ]
        }
      ]
    }
  ],
  "context": [
    "These middlewares are used throughout the application to:",
    "Protect endpoints that require authentication",
    "Attach authenticated user/client data to requests for use in route handlers",
    "Standardize authentication error responses (all return 403 with JSON error format)",
    "Provide different authentication levels (Firebase user, NX user, or API client)"
  ],
  "best_practices": [
    "Use verify_user_auth for Firebase user authentication",
    "Use nx_user_login for NX user authentication with user lookup",
    "Use client_login for API client authentication",
    "All middlewares return 403 with JSON error format on failure",
    "Attached user/client objects are available in all subsequent middleware and route handlers"
  ]
}
