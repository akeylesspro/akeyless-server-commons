<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>src/middlewares/auth_mw.ts</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="content">
    <h1>src/middlewares/auth_mw.ts</h1>
    <h2>Purpose</h2>
    <p>Authentication middleware for Firebase users, NX users, and API clients. Provides three middleware functions that verify authentication tokens and attach authenticated user/client data to the request object for use in route handlers.</p>

    <h2>Dependencies</h2>
    <ul>
      <li><strong>Helpers:</strong>
        <ul>
          <li><a href="../helpers/firebase_helpers.html"><code>verify_token</code></a> - Verifies Firebase authentication tokens from Authorization header</li>
          <li><a href="../helpers/global_helpers.html"><code>json_failed</code></a> - Creates standardized error response objects</li>
          <li><a href="../helpers/firebase_helpers.html"><code>query_document_optional</code></a> - Queries Firestore for optional document retrieval</li>
          <li><a href="../helpers/login_helpers.html"><code>get_user_by_identifier</code></a> - Retrieves NX user by phone number or email</li>
        </ul>
      </li>
      <li><strong>Managers:</strong>
        <ul>
          <li><a href="../managers/logger_manager.html"><code>logger</code></a> - Logging manager for error tracking</li>
        </ul>
      </li>
      <li><strong>Types:</strong>
        <ul>
          <li><a href="../types/types/global.html"><code>MW</code></a> - Express middleware type definition</li>
        </ul>
      </li>
      <li><strong>External Types:</strong>
        <ul>
          <li><code>NxUser</code> - NX user type from <code>akeyless-types-commons</code></li>
          <li><code>Client</code> - API client type from <code>akeyless-types-commons</code></li>
        </ul>
      </li>
    </ul>

    <h2>Exports</h2>

    <h3><code>verify_user_auth: MW</code></h3>
    <p>Firebase user authentication middleware that validates bearer tokens from the Authorization header.</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Extracts the <code>Authorization</code> header from the request</li>
      <li>Verifies the Firebase authentication token using <code>verify_token</code></li>
      <li>On success: Attaches the decoded Firebase user object to <code>req.body.firebase_user</code> and calls <code>next()</code></li>
      <li>On failure: Logs the error using <code>logger.error</code>, responds with HTTP 403 status and a JSON error response using <code>json_failed</code></li>
    </ul>
    <p><strong>Usage:</strong></p>
    <pre><code>app.get('/protected-route', verify_user_auth, (req, res) => {
  // req.body.firebase_user is available here
  const user = req.body.firebase_user;
});</code></pre>
    <p><strong>Error Handling:</strong> Catches any errors during token verification and returns 403 Forbidden status with error details in JSON format.</p>

    <h3><code>nx_user_login: MW</code></h3>
    <p>NX user login middleware that validates Firebase tokens and resolves the corresponding NX user from the database.</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Extracts the <code>Authorization</code> header from the request</li>
      <li>Verifies the Firebase authentication token to get user data</li>
      <li>Validates that the token contains either a <code>phone_number</code> or <code>email</code> field</li>
      <li>Queries the NX users collection using <code>get_user_by_identifier</code> with the phone number or email</li>
      <li>Constructs a <code>full_name</code> field by concatenating <code>first_name</code> and <code>last_name</code> (trimmed)</li>
      <li>On success: Attaches the NX user object with <code>full_name</code> to <code>req.body.user</code> as <code>NxUser</code> type and calls <code>next()</code></li>
      <li>On failure: Responds with HTTP 403 status and a JSON error response</li>
    </ul>
    <p><strong>Validation:</strong> Ensures token contains at least one identifier (phone_number or email) and verifies that a matching NX user exists in the database.</p>
    <p><strong>Usage:</strong></p>
    <pre><code>app.post('/api/user-data', nx_user_login, (req, res) => {
  // req.body.user is available here with full_name property
  const nxUser = req.body.user;
});</code></pre>
    <p><strong>Error Handling:</strong> Returns 403 Forbidden if token is invalid, missing identifiers, or user not found. Error messages include specific details about what failed.</p>

    <h3><code>client_login: MW</code></h3>
    <p>API client authentication middleware that validates API tokens against the <code>nx-clients</code> collection.</p>
    <p><strong>Behavior:</strong></p>
    <ul>
      <li>Extracts the <code>Authorization</code> header from the request</li>
      <li>Validates that the token exists (throws error if missing)</li>
      <li>Queries the <code>nx-clients</code> collection using <code>query_document_optional</code> with field <code>api_token</code> matching the provided token</li>
      <li>On success: Attaches the client document to <code>req.body.client</code> as <code>Client</code> type and calls <code>next()</code></li>
      <li>On failure: Responds with HTTP 403 status and a JSON error response</li>
    </ul>
    <p><strong>Validation:</strong> Ensures Authorization header is present and verifies that a client exists with the provided API token.</p>
    <p><strong>Usage:</strong></p>
    <pre><code>app.post('/api/client-endpoint', client_login, (req, res) => {
  // req.body.client is available here
  const client = req.body.client;
});</code></pre>
    <p><strong>Error Handling:</strong> Returns 403 Forbidden if token is missing or no matching client is found.</p>

    <h2>Request Object Modifications</h2>
    <p>All three middlewares modify <code>req.body</code> to attach authentication data:</p>
    <ul>
      <li><code>verify_user_auth</code> → <code>req.body.firebase_user</code> (Firebase decoded user)</li>
      <li><code>nx_user_login</code> → <code>req.body.user</code> (NX user with full_name)</li>
      <li><code>client_login</code> → <code>req.body.client</code> (API client document)</li>
    </ul>

    <h2>Context</h2>
    <p>These middlewares are used throughout the application to:</p>
    <ul>
      <li>Protect endpoints that require authentication</li>
      <li>Attach authenticated user/client data to requests for use in route handlers</li>
      <li>Standardize authentication error responses (all return 403 with JSON error format)</li>
      <li>Provide different authentication levels (Firebase user, NX user, or API client)</li>
    </ul>

    <h2>Error Response Format</h2>
    <p>All middlewares use <code>json_failed</code> to return consistent error responses:</p>
    <pre><code>{
  success: false,
  error: &lt;error message or error object&gt;
}</code></pre>

    <h2>Integration Notes</h2>
    <ul>
      <li>These middlewares are typically used in Express route chains before the final route handler</li>
      <li>They can be combined with other middlewares like <code>mandatory</code> for header validation</li>
      <li>The attached user/client objects are available in all subsequent middleware and route handlers</li>
    </ul>
    </div>
  </body>
</html>
